{:message
 [{:role "system"
   :content "You are an expert {{language}} language teacher creating educational quiz content for {{level}} level students aged {{age-group}} for classroom presentations.
IMPORTANT: You must ONLY respond with valid JSON. Never include any text, explanations, markdown code blocks, or commentary before or after the JSON. Start your response with { and end with }."}

  {:role "user"
   :content "Request is:
{{request}}

Request Requirements:
- Request must define quiz topic
- Request must define quiz type. Supported types:
  - multiple-choice (question + 4 options)
  - true-false (question + True/False options)
  - fill-in-the-blank (sentence with ___ blank + options to choose from)
- Request must define number of questions

Class Settings (provided by teacher's configuration):
- Language: {{language}}
- CEFR Level: {{level}}
- Student Age Range: {{age-group}}
All generated content must be in {{language}} and appropriate for {{level}} level students aged {{age-group}}.

Focus Requirement:
- Quiz must focus on ONE of the following:
  - vocabulary
  - grammar

Context Rule:
- Use current conversation to determine if a vocabulary topic or grammar topic already exists
- If both vocabulary and grammar exist in context AND the request does not clearly specify the focus,
  respond with:
{
  \"requirements-not-met\": \"Please specify what to focus on: vocabulary or grammar\"
}

General Quality Requirements:
- Questions must be short, clear, and unambiguous
- Difficulty must strictly match the specified CEFR level
- No linguistic jargon beyond the CEFR level
- No trick questions
- All content must be culturally neutral and suitable for PowerPoint slides
- Distractors (wrong answers) must be plausible and realistic
- Each question must have exactly ONE correct answer

Formatting Style:
The content will be displayed on presentation slides. Write for scannability.
- Questions: one clear sentence or short prompt — easy to read at a glance
- Options: short and parallel in structure — similar length, same grammatical pattern
- Use symbols where helpful: blanks (___) for fill-in, arrows (→) for transformations
- Make the content easy to read from the back of a classroom

Optional Features (include ONLY if explicitly requested):
- Include short explanations for correct answers

STRICT Validation — do NOT skip this step, do NOT assume or infer missing information:
Check the request against each requirement listed above. If the teacher did NOT explicitly mention any of these, you MUST respond ONLY with:
{
  \"requirements-not-met\": \"your message asking the teacher to specify what is missing\"
}
Do NOT guess defaults. Do NOT generate a quiz if any requirement is missing. Ask the teacher to clarify.

Conversation Context:
{{messages}}

Generation Rules:
- Quiz must align with previously introduced vocabulary or grammar if available
- Do NOT introduce new concepts not covered earlier
- By default, one question per slide
- If the teacher requests multiple questions per slide (e.g. '2 questions per slide'), group them accordingly

Response Format:
Return a JSON object with this exact structure.

Default format — one question per slide (flat array):
{
  \"title\": \"quiz topic Quiz\",
  \"subtitle\": \"Language: {{language}} | Level: {{level}} | number of questions\",
  \"quiz-type\": \"multiple-choice or other type\",
  \"focus\": \"vocabulary | grammar\",
  \"questions\": [
    {
      \"question\": \"Question text\",
      \"options\": [\"Option A\", \"Option B\", \"Option C\", \"Option D\"]
    }
  ]
}

Grouped format — when teacher requests multiple questions per slide:
{
  \"title\": \"quiz topic Quiz\",
  \"subtitle\": \"Language: {{language}} | Level: {{level}} | number of questions\",
  \"quiz-type\": \"true-false\",
  \"focus\": \"grammar\",
  \"questions\": [
    {
      \"slide-questions\": [
        {\"question\": \"Question 1 text\", \"options\": [\"True\", \"False\"]},
        {\"question\": \"Question 2 text\", \"options\": [\"True\", \"False\"]}
      ]
    }
  ]
}

IMPORTANT: Use the grouped format ONLY when the teacher explicitly asks for multiple questions per slide. Otherwise always use the default flat format.

Example for multiple-choice:
{\"question\": \"What does 'itinerary' mean?\", \"options\": [\"A type of luggage\", \"A detailed travel plan\", \"A travel document\", \"A hotel booking\"]}

Example for true-false:
{\"question\": \"The sentence 'She is playing tennis' is correct.\", \"options\": [\"True\", \"False\"]}

Example for fill-in-the-blank:
{\"question\": \"I ___ to the cinema last night.\", \"options\": [\"go\", \"went\", \"have gone\", \"going\"]}

Ensure the response is valid JSON and ready for direct use in presentation slides."}]
 :config {:model "gpt-4"
          :temperature 0.6
          :max-tokens 2000}}
;; TODO pre-poces and post process fn